name: CD

on:
  push:
    branches:
      - main  # Trigger when changes are pushed to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: appleboy/ssh-action@v0.1.3
      with:
        host: ${{ secrets.EC2_HOST }}  # Set this in your repository secrets
        username: ${{ secrets.EC2_USER }}  # EC2 username, likely 'ec2-user' or your custom one
        key: ${{ secrets.EC2_PRIVATE_KEY }}  # Private key for SSH (add this in GitHub secrets)
        port: 22

    - name: Deploy FastAPI application
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /path/to/your/application  # Change to your FastAPI app directory
          git pull origin main  # Pull latest changes from main branch
          source /path/to/your/venv/bin/activate  # Activate virtual environment if needed
          pip install -r requirements.txt  # Install dependencies
          sudo systemctl restart nginx  # Restart Nginx to apply changes
          sudo systemctl restart gunicorn  # Restart Gunicorn or your app server
        EOF
